<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ product.name }}</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.4; margin: 24px; color: #222; }
    .nav a { margin-right: 12px; color: purple; text-decoration: none; }
    .nav a:hover { text-decoration: underline; }
    .messages { margin: 12px 0; padding: 10px; border-radius: 4px; }
    .messages.success { background: #d4edda; color: #155724; }
    .messages.error { background: #f8d7da; color: #721c24; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 12px; background: #eef; }
    .verified { color: #067a00; font-weight: bold; }
    .muted { color: #666; }
    .section { margin-top: 20px; }
    .add-to-cart button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .reviews ul { list-style: none; padding-left: 0; }
    .reviews li { border-bottom: 1px solid #eee; padding: 10px 0; }
    label { font-weight: bold; }
    input[type="number"], textarea { padding: 6px; width: 100%; max-width: 260px; box-sizing: border-box; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <div class="nav">
    <a href="{% url 'ecommerce:catalog_product_list' product.store.id %}">Back to {{ product.store.name }}</a>
    <a href="{% url 'ecommerce:view_cart' %}">Cart</a>
    <a href="{% url 'ecommerce:welcome' %}">Home</a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="messages {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <h2>{{ product.name }}</h2>

  <p><strong>Price:</strong> R{{ product.price|floatformat:2 }}</p>

  {# Show stock correctly (0 should display) #}
  {% if product.stock is not None %}
    {% if product.stock|add:0 <= 0 %}
      <p><strong>Stock:</strong> 0 <span class="muted">(Out of stock)</span></p>
    {% else %}
      <p><strong>Stock:</strong> {{ product.stock }}</p>
    {% endif %}
  {% endif %}

  {% if product.store %}
    <p class="muted">Store: <strong>{{ product.store.name }}</strong></p>
  {% endif %}

  <div class="section add-to-cart">
    <form method="post" action="{% url 'ecommerce:add_to_cart' %}">
      {% csrf_token %}
      <input type="hidden" name="product_id" value="{{ product.id }}">
      <label for="qty">Qty</label><br>
      <input id="qty" type="number" name="qty" value="1" min="1"
             {% if product.stock is not None and product.stock > 0 %}max="{{ product.stock }}"{% endif %}
             required>
      <br><br>
      <button type="submit"
              {% if product.stock is not None and product.stock|add:0 <= 0 %}disabled{% endif %}>
        Add to cart
      </button>
    </form>
  </div>

  <hr>

  <div class="section">
    {% with reviews|length as review_count %}
      {% if review_count %}
        <p class="muted">
          {% if avg_rating|default:'' != '' %}
            Average rating: {{ avg_rating|floatformat:1 }}/5 ·
          {% endif %}
          {{ review_count }} review{{ review_count|pluralize }}
        </p>
      {% endif %}
    {% endwith %}
  </div>

  <div class="section reviews">
    <h3>Reviews</h3>
    {% if reviews %}
      <ul>
        {% for r in reviews %}
          <li>
            <strong>{{ r.user.username }}</strong>
            — Rating: {{ r.rating }}/5
            {% if r.verified %}
              <span class="verified" title="Verified purchaser">✔ verified</span>
            {% endif %}
            <br>
            <small class="muted">{{ r.created_at|date:"Y-m-d H:i" }}</small>
            {% if r.comment %}<p>{{ r.comment }}</p>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No reviews yet.</p>
    {% endif %}
  </div>

  <div class="section">
    {% if user.is_authenticated %}
      <h4>Write a review</h4>
      <form method="post" action="{% url 'ecommerce:add_review' product.id %}">
        {% csrf_token %}
        {{ review_form.non_field_errors }}

        <label for="id_rating">Rating (1–5):</label><br>
        {{ review_form.rating }}
        {{ review_form.rating.errors }}
        <br><br>

        <label for="id_comment">Comment (optional):</label><br>
        {{ review_form.comment }}
        {{ review_form.comment.errors }}
        <br><br>

        <button type="submit">Submit review</button>
      </form>
    {% else %}
      <p>
        <a href="{% url 'ecommerce:login' %}?next={{ request.path }}">Log in</a>
        to write a review.
      </p>
    {% endif %}
  </div>
</body>
</html>
